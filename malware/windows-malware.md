# Windows Malware

## Call Stack spoofing

- https://learn.microsoft.com/en-us/cpp/build/exception-handling-x64
- 2022/06/30: https://labs.withsecure.com/publications/spoofing-call-stacks-to-confuse-edrs
- 2022/12/08: https://klezvirus.github.io/RedTeaming/AV_Evasion/StackSpoofing/
- https://github.com/Kudaes/Unwinder

## Injection

- https://disman.tl/2015/01/30/an-improved-reflective-dll-injection-technique.html
- https://github.com/Kudaes/EPI

## Heap encryption

- https://www.arashparsa.com/hook-heaps-and-live-free/

## PE Loader

Being able to load PE binaries is an important feature that many malware
implement.

- https://github.com/stephenfewer/ReflectiveDLLInjection
- https://github.com/bats3c/DarkLoadLibrary
- https://github.com/fortra/No-Consolation
- https://github.com/TheWover/donut
- https://github.com/monoxgas/sRDI

### API sets

API sets are like subsets of libraries functionalities that can be bundled
together and will allow to be provided by different DLLs in different Windows
devices, like computers, Xbox, etc. A PE can import functions from
an API set and then the linker in runtime will redirect this import to the
proper library.

An example of apiset is like this one:

`api-ms-win-core-synch-l1-1-0.dll` -> `kernelbase.dll`

- https://github.com/ajkhoury/ApiSet
- https://blog.quarkslab.com/runtime-dll-name-resolution-apisetschema-part-i.html
- https://blog.quarkslab.com/runtime-dll-name-resolution-apisetschema-part-ii.html
- https://geoffchappell.com/studies/windows/win32/apisetschema/index.htm

## Shellcode

- https://github.com/Cracked5pider/Stardust
- https://defuse.ca/online-x86-assembler.htm

## Sleep Encryption

- 2017/03/04
  https://lospi.net/security/assembly/c/cpp/developing/software/2017/03/04/gargoyle-memory-analysis-evasion.html
- 2021/09/10
  https://www.solomonsklash.io/SleepyCrypt-shellcode-to-encrypt-a-running-image.html - https://github.com/SolomonSklash/SleepyCrypt
- 2022/04/23
  https://www.arashparsa.com/bypassing-pesieve-and-moneta-the-easiest-way-i-could-find/ - https://github.com/waldo-irc/YouMayPasser
- 2022/05/05 https://web.archive.org/web/20220625003531/https://suspicious.actor/2022/05/05/mdsec-nighthawk-study.html - https://github.com/Cracked5pider/Ekko
- 2022/07/30 https://github.com/janoglezcampos/DeathSleep
- 2022/08/29 https://icebreaker.team/blogs/sleeping-with-control-flow-guard/
- 2022/11/06 https://idov31.github.io/2022/11/06/cronos-sleep-obfuscation.html - https://github.com/Idov31/Cronos

- https://github.com/y11en/FOLIAGE (Original from https://github.com/SecIdiot/FOLIAGE)


## Syscalls

System calls or syscalls are a mean used for the user space code to request
actions to the kernel. You can consider syscalls as the API the kernel
exposes. Different OS implements syscalls in a different way. In the case of
Windows, all syscalls are managed and exported by the ntdll library, in
functions with the name starting by `Nt` or `Zw` like `NtDelayExecution` (which
is the syscall that sleep uses).

Here is an example of the `NtDelayexecution`:
```
0:000> u ntdll!NtDelayExecution
ntdll!NtDelayExecution:
00007ff8`e1fcdb60 4c8bd1          mov     r10,rcx
00007ff8`e1fcdb63 b834000000      mov     eax,34h
00007ff8`e1fcdb68 f604250803fe7f01 test    byte ptr [SharedUserData+0x308 (00000000`7ffe0308)],1
00007ff8`e1fcdb70 7503            jne     ntdll!NtDelayExecution+0x15 (00007ff8`e1fcdb75)
00007ff8`e1fcdb72 0f05            syscall
00007ff8`e1fcdb74 c3              ret
00007ff8`e1fcdb75 cd2e            int     2Eh
00007ff8`e1fcdb77 c3              ret
```

You can see that it moves the value `0x34` to `eax` and then, after a check, it
executes the `syscall` instruction, that is used in x64 (which is x86 for 64
bits) to invoke the kernel. The value passed in `eax` is known as the Service
System Number or SSN, and it will indicate the kernel what syscalls is
requested. In this case the syscall `NtDelayExecution` has the SSN `0x34`.

You can check the SSN for the different Windows versions in theses tables:
- [Windows X86-64 System Call Table](https://j00ru.vexillium.org/syscalls/nt/64/)
- [Windows X86 System Call Table](https://j00ru.vexillium.org/syscalls/nt/32/)

And here there are some articles and tools about syscalls:
- 2022-01 [x86 Nirvana Hooks & Manual Syscall
  Detection](https://blog.xenoscr.net/2022/01/17/x86-Nirvana-Hooks.html) by
  Conor Richard
- 2021-02-10 [Detecting Manual Syscalls from User
  Mode](https://winternl.com/detecting-manual-syscalls-from-user-mode/) by winternl
- 2022-01-29 [EDR Bypass : Retrieving Syscall ID with Hell's Gate, Halo's Gate,
  FreshyCalls and
  Syswhispers2](https://alice.climent-pommeret.red/posts/direct-syscalls-hells-halos-syswhispers2/)
  by Alice
- 2022-03-24 [A Syscall Journey in the Windows
  Kernel](https://alice.climent-pommeret.red/posts/a-syscall-journey-in-the-windows-kernel/)
  by Alice
- 2020-06-10 [FreshyCalls: Syscalls Freshly
  Squeezed!](https://web.archive.org/web/20220929111239/https://www.crummie5.club/freshycalls/)
  by ElephantSe4l
- [FreshyCalls (tool)](https://github.com/crummie5/FreshyCalls)
- [SysWhispers2 (tool)](https://github.com/jthuraisamy/SysWhispers2)
- [SysWhispers3 (tool)](https://github.com/klezVirus/SysWhispers3)
- 2022/04 [Resolving System Service Numbers using the Exception
  Directory](https://www.mdsec.co.uk/2022/04/resolving-system-service-numbers-using-the-exception-directory/)
  by [modexpblog](https://x.com/modexpblog)
- 2019-06-19 [Red Team Tactics: Combining Direct System Calls and sRDI to bypass
  AV/EDR](https://outflank.nl/blog/2019/06/19/red-team-tactics-combining-direct-system-calls-and-srdi-to-bypass-av-edr/)
  by Cornelis
- [HellsGate (tool)](https://github.com/am0nsec/HellsGate)
- [HellsGate](https://vxug.fakedoma.in/papers/VXUG/Exclusive/HellsGate.pdf)
- 2022/03/09 [HellGate Technique on AV
  Bypass](https://rioasmara.com/2022/03/09/hellgate-technique-on-av-bypass/) by Rio Asmara Suryadi
- [HellsHall (tool)](https://github.com/Maldev-Academy/HellHall)
- 2021/04/23 [Halo's Gate - twin sister of Hell's Gate](https://blog.sektor7.net/#!res/2021/halosgate.md)
- [UnhookingPatch](https://github.com/D1rkMtr/UnhookingPatch)
- [TartarusGate (tool)](https://github.com/trickster0/TartarusGate)
